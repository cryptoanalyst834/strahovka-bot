import 'dotenv/config';
import express           from 'express';
import { Telegraf }      from 'telegraf';
import OpenAI            from 'openai';

const {
  TELEGRAM_TOKEN,
  OPENROUTER_API_KEY,
  DOMAIN,
  PORT = 8080
} = process.env;

if (!TELEGRAM_TOKEN || !OPENROUTER_API_KEY || !DOMAIN) {
  console.error('‚ùå Set TELEGRAM_TOKEN, OPENROUTER_API_KEY and DOMAIN in env');
  process.exit(1);
}

// simple in-memory session & privacy tracking
const sessions = new Map();
const privacyMentioned = new Map();

// 1) Express + healthcheck + webhook endpoint
const app = express();
app.use(express.json());
app.get('/', (_req, res) => res.send('OK'));

// 2) Telegram bot
const bot = new Telegraf(TELEGRAM_TOKEN);

// 3) OpenRouter client
const openai = new OpenAI({
  apiKey: OPENROUTER_API_KEY,
  baseURL: 'https://openrouter.ai/api/v1'
});

// 4) Widget links
const services = {
  "–û–°–ê–ì–û":                   "https://widgets.inssmart.ru/contract/eosago?appId=bbac9045-39c4-5530-a953-d63f4d081fe0&secret=2d2759bd-a1b0-57a7-803b-520c1a262740",
  "–ú–ò–ù–ò-–ö–ê–°–ö–û":              "https://widgets.inssmart.ru/contract/kasko?appId=293563a6-dcb8-543c-84a7-7a455578884f&secret=5d05ad7d-7fc6-58b8-8851-6de24394a0a6",
  "–ò–ø–æ—Ç–µ–∫–∞":                 "https://widgets.inssmart.ru/contract/mortgage?appId=e06a1d3f-604c-52d2-bc8a-b9b8e2e7e167&secret=695aa6ff-001b-52ec-99de-0dbd38762b93",
  "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞":   "https://widgets.inssmart.ru/contract/property?appId=34daded4-ba8c-5e60-883b-bddd168b35b0&secret=ff271c00-fb5a-5de2-9b9e-fcfb8660da84",
  "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è":             "https://widgets.inssmart.ru/contract/travel?appId=a8bf576a-c303-5c66-8952-5a2a5bcf0b04&secret=95f250f5-b561-5593-99ad-575fec648e4c"
};

// 5) Off-widget topics
const outsideTriggers = [
  "–ö–ê–°–ö–û –ü–û –†–ò–°–ö–ê–ú","–¢–û–¢–ê–õ","–£–ì–û–ù","–î–ú–°","–°–¢–†–ê–•–û–í–ê–ù–ò–ï –ë–ò–ó–ù–ï–°–ê","–£–©–ï–†–ë","–î–û–ë–†–û–í–û–õ–¨–ù–û–ï –ú–ï–î–ò–¶–ò–ù–°–ö–û–ï –°–¢–†–ê–•–û–í–ê–ù–ò–ï"

];
const outsideWidgetResponse = `
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω—É–∂–Ω—ã–π –≤–∏–¥ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è –≤ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–µ–π –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞:
üìß info@straxovka-go.ru
üåê https://straxovka-go.ru
üì± WhatsApp: +7 989 120 66 37

`.trim();

// 6) Insurance keywords
const insuranceKeywords = [
  "–û–°–ê–ì–û","–ö–ê–°–ö–û","–î–ú–°","–ò–ü–û–¢–ï–ö–ê","–ò–ú–£–©–ï–°–¢–í–û",
  "–°–¢–†–ê–•–û–í–ê–ù–ò–ï","–ü–û–õ–ò–°","–î–û–ö–£–ú–ï–ù–¢","–î–¢–ü","–°–¢–û–ò–ú–û–°–¢–¨","–ü–£–¢–ï–®–ï–°–¢–í–ò–ï","–ü–û–î–†–û–ë–ù–ï–ï","–ü–†–û–î–û–õ–ñ–ò"
];

// 7) Topics to block
const blockedTopics = [
  // politics
  "–ü–û–õ–ò–¢–ò–ö–ê","–ü–†–ê–í–ò–¢–ï–õ–¨–°–¢–í–û","–í–´–ë–û–†–´","–ú–ò–õ–ò–¢–ê–†","–í–û–ô–ù–ê",
  // religion
  "–ë–û–ì","–¶–ï–†–ö–û–í–¨","–†–ï–õ–ò–ì–ò–Ø","–ú–û–õ–ò–¢–í–ê","–ò–°–¢–ò–ù–û","–°–í–Ø–¢–û–ï",
  // medicine
  "–õ–ï–ö–ê–†–°–¢–í–û","–ë–û–õ–ï–ó–ù","–ú–ï–î–ò–¶–ò–ù","–í–†–ê–ß","–õ–ï–ß–ï–ù–ò–ï"
];
const blockedResponse = `
–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –æ–±—Å—É–∂–¥–∞—Ç—å —ç—Ç—É —Ç–µ–º—É.
–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:
üìß info@straxovka-go.ru  
üåê https://straxovka-go.ru  
`.trim();

// 8) /start ‚Äî menu
bot.start(ctx => {
  const keyboard = Object.keys(services).map(k => ([{ text: k }]));
  return ctx.reply(
    "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. " +
    "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å:",
    { reply_markup:{ keyboard, resize_keyboard:true } }
  );
});

// 9) Webhook
app.post('/webhook', (req, res) => {
  bot.handleUpdate(req.body, res).catch(console.error);
});

// 10) Text handler
bot.on('text', async ctx => {
  const txt = ctx.message.text.trim();
  const chatId = String(ctx.chat.id);
  const upper = txt.toUpperCase();

  // 10.1 widget button
  if (services[txt]) {
    return ctx.replyWithHTML(
      `–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ <b>${txt}</b> –∑–¥–µ—Å—å:`,
      { reply_markup:{ inline_keyboard:
        [[{ text:'‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç', url:services[txt] }]]
      } }
    );
  }

  // 10.2 off-widget
  if (outsideTriggers.some(tr => upper.includes(tr))) {
    return ctx.reply(outsideWidgetResponse);
  }

  // 10.3 blocked topics
  if (blockedTopics.some(bt => upper.includes(bt))) {
    return ctx.reply(blockedResponse);
  }

  // 10.4 not insurance ‚Üí off-widget
  if (!insuranceKeywords.some(kw => upper.includes(kw))) {
    return ctx.reply(outsideWidgetResponse);
  }

  // 10.5 AI session
  let session = sessions.get(chatId);
  if (!session) {
    session = { history: [] };
    sessions.set(chatId, session);
  }
  session.history.push({ role:'user', content:txt });

  const firstTime = !privacyMentioned.get(chatId);
  let systemPrompt = `
–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Straxovka-Go, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—é, –∏–º–µ–µ—à—å –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –º–∞—Ä—Ç–∫–µ—Ç–æ–ª–æ–≥–æ–º –±–æ–ª–µ–µ 5 –ª–µ—Ç. –í–µ–¥–µ—à—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –û–±—â–∞–µ—à—å—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.
–¶–µ–ª–∏:
‚Ä¢ –ó–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞—Ö–∏ –∏ –±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞.
‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–≥–æ–¥—ã (—ç–∫–æ–Ω–æ–º–∏—è, —Å–∫–æ—Ä–æ—Å—Ç—å).
‚Ä¢ –ü–æ–¥—Ç–æ–ª–∫–Ω—É—Ç—å –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏.

–°—Ç–∏–ª—å: –∫–æ—Ä–æ—Ç–∫–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ –¥–µ–ª—É.
–ü—Ä–∏–º–µ—Ä—ã —É—Å–ª–æ–≤–∏–π –¥–∏–∞–ª–æ–≥–∞:
1) –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã", —Å–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ —É—Å–ª—É–≥—É (–û–°–ê–ì–û, –ú–ò–ù–ò-–ö–ê–°–ö–û, –ò–ø–æ—Ç–µ–∫–∞, –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞, –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è).
2) –ï—Å–ª–∏ —É—Å–ª—É–≥–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞, –ø–µ—Ä–µ—á–∏—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –Ω–µ—ë.
3) –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–∏–¥–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –≤–∏–¥–∂–µ—Ç–∞—Ö (–î–ú–°, –±–∏–∑–Ω–µ—Å-—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ–ª–∏–∑–∏–Ω–≥), –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é:
   ¬´–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 989 120 66 37, email info@straxovka-go.ru –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ —Å–∞–π—Ç–µ https://straxovka-go.ru¬ª.
4) –ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –æ –î–¢–ü/—É–±—ã—Ç–∫–∞—Ö —É—Ç–æ—á–Ω–∏ —Å—Ç—Ä–∞—Ö–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é –∏ –¥–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –µ–≤—Ä–æ–ø—Ä–æ—Ç–æ–∫–æ–ª—É –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—é –≤ —Å—Ç—Ä–∞—Ö–æ–≤—É—é.
5) –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ –∫–∞–Ω–∞–ª—ã, –∫—Ä–æ–º–µ –Ω–∞—à–∏—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π.
6) –ë–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –Ω–∏–∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.
–ü—Ä–∏–º–µ—Ä—ã –¥–∏–∞–ª–æ–≥–∞:
1. –í—Ä–æ–ø—Ä–æ—Å: –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –æ—Å–∞–≥–æ?
–û—Ç–≤–µ—Ç: –î–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü
–û—Ñ–æ—Ä–º–∏—Ç–µ –û–°–ê–ì–û –æ–Ω–ª–∞–π–Ω ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ.
–ß—Ç–æ–±—ã –Ω–∞–¥–µ–∂–Ω–æ –∑–∞—â–∏—Ç–∏—Ç—å —Å–µ–±—è –æ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –±–µ–∑ –û–°–ê–ì–û –∏–ª–∏ —Å –ø–æ–¥–¥–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª–∏—Å–∞–º–∏, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –ö–ê–°–ö–û –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä—ã–π –∏ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∑–∞—â–∏—Ç—É.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ö–ê–°–ö–û ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∑–∞—è–≤–∫–µ.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞–º 
2. –í–æ–ø—Ä–æ—Å: –ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û?
–û—Ç–≤–µ—Ç: –ú–∏–Ω–∏-–∫–∞—Å–∫–æ –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —É—â–µ—Ä–± –≤ –î–¢–ü –ø–æ –≤–∏–Ω–µ —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü,  –∫–æ–≥–¥–∞ –≤–∏–Ω–æ–≤–Ω–∏–∫ –Ω–µ –∏–º–µ–µ—Ç –û–°–ê–ì–û –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã–π –ª–∏–±–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –ø–æ–ª–∏—Å.
–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ —á–µ—Ä–µ–∑ –æ–Ω–ª–∞–π–Ω-–≤–∏–¥–∂–µ—Ç:
–û—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û
–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ö–ê–°–ö–û –ø–æ –∑–∞—è–≤–∫–µ.
–ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å–≤—è–∑–∏:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞–º 
3. –í–æ–ø—Ä–æ—Å: –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É?
–û—Ç–≤–µ—Ç: –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏ ‚Äî –∑–∞—â–∏—Ç–∞ –ø–æ —Ä–∏—Å–∫–∞–º –∏–º—É—â–µ—Å—Ç–≤–∞, –∂–∏–∑–Ω–∏ –∏ —Ç–∏—Ç—É–ª–∞ —Å –≤—ã–≥–æ–¥–æ–π 10% –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –°–±–µ—Ä–±–∞–Ω–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
–ü–æ–º–Ω–∏—Ç–µ, –±–∞–Ω–∫ —Å—Ç—Ä–∞—Ö—É–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏ –≤–∞—à–µ–≥–æ –∂–∏–ª—å—è. –ß—Ç–æ–±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—Ç–∏—Ç—å –¥–æ–º ‚Äî –æ—Ç–¥–µ–ª–∫—É, –º–µ–±–µ–ª—å –∏ –ª–∏—á–Ω—ã–µ –≤–µ—â–∏ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º.
–ú—ã –ø–æ–º–æ–∂–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ –æ–Ω–ª–∞–π–Ω:
–û—Ñ–æ—Ä–º–∏—Ç—å
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞–º 
4. –í–æ–ø—Ä–æ—Å: –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞?
–û—Ç–≤–µ—Ç: –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ ‚Äî –ª–∏—á–Ω–æ–µ
–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, –¥–æ–º–∞, –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤, –∫–æ–º–Ω–∞—Ç—ã, —Ç–∞—É–Ω—Ö–∞—É—Å–∞, –¥–æ–º–∞ —Å —É—á–∞—Å—Ç–∫–æ–º, –±–∞–Ω–∏.
üìå –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –∏–ø–æ—Ç–µ–∫–µ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –≠—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç –ø–æ–ª–∏—Å, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –¥–ª—è –±–∞–Ω–∫–∞, –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –ø–æ–ª–Ω—É—é –∑–∞—â–∏—Ç—É –≤–∞—à–µ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞.
–û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω
–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ ‚Äî –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ
–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ñ–∏—Å–∞, —Å–∫–ª–∞–¥–∞, –º–∞–≥–∞–∑–∏–Ω–∞, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π.
–ß—Ç–æ–±—ã –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø–µ—Ä–µ—á–Ω–µ–º —Ä–∏—Å–∫–æ–≤ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ–ª–∏—Å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
 –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω
–í—ã –Ω–µ –Ω–∞—à–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ?
–û—Å—Ç–∞–≤—å—Ç–µ –Ω–∞–º –∑–∞—è–≤–∫—É.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
5. –í–æ–ø—Ä–æ—Å: –∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è?
–û—Ç–≤–µ—Ç: –ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –Ω–∞—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.–¢–∞–º –≤—ã —Å–º–æ–∂–µ—Ç–µ –±—ã—Å—Ç—Ä–æ –≤—ã–±—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ:
–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ, –º—ã  –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
`;
  if (firstTime) {
    systemPrompt += `
–ï–¥–∏–Ω–æ–∂–¥—ã –≤ –ø–µ—Ä–≤–æ–º –æ—Ç–≤–µ—Ç–µ —É–ø–æ–º—è–Ω–∏, —á—Ç–æ –º—ã ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ü–î–Ω, –∏ –¥–∞–π —Å—Å—ã–ª–∫—É:
https://straxovka-go.ru/privacy
`;
    privacyMentioned.set(chatId, true);
  } else {
    systemPrompt += "\n–ù–µ —É–ø–æ–º–∏–Ω–∞–π –ø–æ–ª–∏—Ç–∏–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ.";
  }

  // build messages
  const messages = [
    { role:'system', content:systemPrompt.trim() },
    ...session.history
  ];

  try {
    const resp = await openai.chat.completions.create({
      model:       'openai/gpt-4o', // or your OpenRouter endpoint
      messages,
      temperature: 0.7,
      max_tokens: 250
    });
    const answer = resp.choices[0].message.content.trim();
    session.history.push({ role:'assistant', content:answer });
    return ctx.reply(answer);
  } catch (err) {
    console.error("OpenRouter Error:", err);
    return ctx.reply("–£–ø—Å, –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
});

// 11) Launch + webhook
app.listen(PORT, async () => {
  console.log(`üåê HTTP server on port ${PORT}`);
  await bot.telegram.setWebhook(`${DOMAIN}/webhook`);
  console.log(`‚úÖ Webhook registered at ${DOMAIN}/webhook`);
});
