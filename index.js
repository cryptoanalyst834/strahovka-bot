import 'dotenv/config';
import express         from 'express';
import session         from 'telegraf/session';
import { Telegraf }    from 'telegraf';
import OpenAI          from 'openai';

const { TELEGRAM_TOKEN, OPENROUTER_API_KEY, DOMAIN, PORT = 8080 } = process.env;
if (!TELEGRAM_TOKEN || !OPENROUTER_API_KEY || !DOMAIN) {
  console.error('‚ùå –ó–∞–¥–∞–π—Ç–µ TELEGRAM_TOKEN, OPENROUTER_API_KEY –∏ DOMAIN –≤ env');
  process.exit(1);
}

// ‚îÄ‚îÄ‚îÄ 1) Express + Webhook endpoint ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const app = express();
app.use(express.json());
app.get('/', (_req, res) => res.send('OK'));  // Healthcheck

// ‚îÄ‚îÄ‚îÄ 2) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ —Å–µ—Å—Å–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const bot = new Telegraf(TELEGRAM_TOKEN);
bot.use(session());  // –¥–ª—è ctx.session.privacyMentioned

const openai = new OpenAI({
  apiKey:  OPENROUTER_API_KEY,
  baseURL: 'https://openrouter.ai/api/v1'
});

// ‚îÄ‚îÄ‚îÄ 3) –í–∏–¥–∂–µ—Ç-—Å—Å—ã–ª–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const services = {
  –û–°–ê–ì–û:       'https://widgets.inssmart.ru/contract/eosago?appId=bbac9045‚Ä¶&secret=2d2759b‚Ä¶',
  '–ú–ò–ù–ò-–ö–ê–°–ö–û': 'https://widgets.inssmart.ru/contract/kasko?appId=293563a‚Ä¶&secret=5d05a‚Ä¶',
  –ò–ø–æ—Ç–µ–∫–∞:     'https://widgets.inssmart.ru/contract/mortgage?appId=e06a1‚Ä¶&secret=695a‚Ä¶',
  '–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞': 'https://widgets.inssmart.ru/contract/property?appId=34dad‚Ä¶&secret=ff27‚Ä¶',
  –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è: 'https://widgets.inssmart.ru/contract/travel?appId=a8bf5‚Ä¶&secret=95f2‚Ä¶'
};

// ‚îÄ‚îÄ‚îÄ 4) –®–∞–±–ª–æ–Ω ¬´–≤–Ω–µ-–≤–∏–¥–∂–µ—Ç–Ω—ã—Ö¬ª –∑–∞–ø—Ä–æ—Å–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const outsideWidgetResponse = `
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω—É–∂–Ω—ã–π –≤–∏–¥ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è –≤ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω. 
–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–µ–π –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞:

üìß info@straxovka-go.ru  
üåê https://straxovka-go.ru  
üì± WhatsApp: +7 989 120 66 37

–û–±—Ä–∞—â–∞–µ–º –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –º—ã —è–≤–ª—è–µ–º—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. 
–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –Ω–∞—à–µ–π –ü–æ–ª–∏—Ç–∏–∫–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: https://straxovka-go.ru/privacy
`.trim();

// –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è ¬´–≤–Ω–µ-–≤–∏–¥–∂–µ—Ç–Ω—ã—Ö¬ª —Ç–µ–º :contentReference[oaicite:9]{index=9}
const outsideTriggers = [
  '–ö–ê–°–ö–û –ø–æ —Ä–∏—Å–∫–∞–º', '–¢–û–¢–ê–õ', '–£–ì–û–ù',
  '–î–ú–°', '—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞'
];

// ‚îÄ‚îÄ‚îÄ 5) /start ‚Äî –≤—ã–≤–æ–¥ –º–µ–Ω—é –∫–Ω–æ–ø–æ–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
bot.start(ctx => {
  const keyboard = Object.keys(services).map(k => ([{ text: k }]));
  return ctx.reply(
    'üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫. –ü–æ–º–æ–≥—É –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É. ' +
    '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å:',
    { reply_markup:{ keyboard, resize_keyboard:true } }
  );
});

// ‚îÄ‚îÄ‚îÄ 6) Webhook endpoint –¥–ª—è Telegraf ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.post('/webhook', (req, res) => {
  bot.handleUpdate(req.body, res).catch(console.error);
});

// ‚îÄ‚îÄ‚îÄ 7) –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ö—ç–Ω–¥–ª–µ—Ä —Ç–µ–∫—Å—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
bot.on('text', async ctx => {
  const txt = ctx.message.text.trim();

  // 7.1 ‚Äî –ö–Ω–æ–ø–∫–∞-–≤–∏–¥–∂–µ—Ç
  if (services[txt]) {
    return ctx.replyWithHTML(
      `–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è <b>${txt}</b>:`,
      { reply_markup:{ inline_keyboard:[
          [{ text:'‚ñ∂ –û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç', url:services[txt] }]
      ] } }
    );
  }

  // 7.2 ‚Äî ¬´–≤–Ω–µ-–≤–∏–¥–∂–µ—Ç–Ω—ã–π¬ª –∑–∞–ø—Ä–æ—Å
  if (outsideTriggers.some(tr => txt.toUpperCase().includes(tr))) {
    return ctx.reply(outsideWidgetResponse);
  }

  // 7.3 ‚Äî –í—ã–∑–æ–≤ OpenRouter –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
  // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º system prompt —Å —à–∞–±–ª–æ–Ω–∞–º–∏ –∏–∑ –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–æ–≤.docx 
  const firstTime = !ctx.session.privacyMentioned;
  const systemPrompt = `
–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—é Straxovka-Go. 
–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–∞ –ø–æ —Ç–µ–º–µ:

‚Äî –û–°–ê–ì–û (—Ñ–∏–∑–∏–∫–∏): ¬´–û—Ñ–æ—Ä–º–∏—Ç–µ –û–°–ê–ì–û –æ–Ω–ª–∞–π–Ω ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ: –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: üåê straxovka-go.ru, üì≤ WhatsApp +7 989 120 66 37, üìß info@straxovka-go.ru.¬ª

‚Äî –û–°–ê–ì–û (—é—Ä –ª–∏—Ü–∞): ¬´–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –û–°–ê–ì–û –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –æ–Ω–ª–∞–π–Ω: –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

‚Äî –ú–ò–ù–ò-–ö–ê–°–ö–û: ¬´–ú–ò–ù–ò-–ö–ê–°–ö–û –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö‚Ä¶ –û—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

‚Äî –ö–ê–°–ö–û: ¬´–î–ª—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –ö–ê–°–ö–û –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∑–∞—è–≤–∫–µ. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

‚Äî –ò–ø–æ—Ç–µ–∫–∞: ¬´–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏‚Ä¶ –û—Ñ–æ—Ä–º–∏—Ç—å. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

‚Äî –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ (–ª–∏—á–Ω–æ–µ): ¬´–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, –¥–æ–º–∞‚Ä¶ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

‚Äî –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ): ¬´–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ñ–∏—Å–∞, —Å–∫–ª–∞–¥–∞‚Ä¶ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

‚Äî –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è: ¬´–î–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É‚Ä¶ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π. 
–ö–æ–Ω—Ç–∞–∫—Ç—ã: ‚Ä¶¬ª

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–æ–≤–ø–∞–ª —Å –æ–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–û–°–ê–ì–û, –ö–ê–°–ö–û –∏ —Ç.–ø.), –æ—Ç–¥–∞–π –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω. 
–ò–Ω–∞—á–µ –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–º–∞—Ç–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç. 
${ firstTime 
    ? '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏, —á—Ç–æ –º—ã ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏ –¥–∞–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É: https://straxovka-go.ru/privacy' 
    : '–ù–µ —É–ø–æ–º–∏–Ω–∞–π—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ.' 
}
`.trim();

  if (firstTime) ctx.session.privacyMentioned = true;

  try {
    const resp = await openai.chat.completions.create({
      model:       'openai/gpt-3.5-turbo',
      messages:    [
        { role:'system', content:systemPrompt },
        { role:'user',   content:txt }
      ],
      temperature: 0.5,
      max_tokens: 200
    });
    return ctx.reply(resp.choices[0].message.content.trim());
  } catch (err) {
    console.error('OpenRouter Error:', err);
    return ctx.reply('–£–ø—Å, –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
});

// ‚îÄ‚îÄ‚îÄ 8) –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
app.listen(PORT, async () => {
  console.log(`üåê HTTP server on port ${PORT}`);
  await bot.telegram.setWebhook(`${DOMAIN}/webhook`);
  console.log(`‚úÖ Webhook registered at ${DOMAIN}/webhook`);
});
