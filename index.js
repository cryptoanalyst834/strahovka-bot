import 'dotenv/config';
import express      from 'express';
import { Telegraf } from 'telegraf';
import OpenAI       from 'openai';

const {
  TELEGRAM_TOKEN,
  OPENROUTER_API_KEY,
  DOMAIN,
  PORT = 8080
} = process.env;

if (!TELEGRAM_TOKEN || !OPENROUTER_API_KEY || !DOMAIN) {
  console.error('‚ùå –ó–∞–¥–∞–π—Ç–µ TELEGRAM_TOKEN, OPENROUTER_API_KEY –∏ DOMAIN –≤ env');
  process.exit(1);
}

// In-memory storage
const sessions = new Map();
const privacyMentioned = new Map();

// Express + healthcheck
const app = express();
app.use(express.json());
app.get('/', (_req, res) => res.send('OK'));

// Telegram + OpenRouter
const bot = new Telegraf(TELEGRAM_TOKEN);
const openai = new OpenAI({
  apiKey:  OPENROUTER_API_KEY,
  baseURL: 'https://openrouter.ai/api/v1'
});

// 1) –í–∏–¥–∂–µ—Ç—ã
const services = {
  –û–°–ê–ì–û:                   "https://widgets.inssmart.ru/contract/eosago?appId=bbac9045-39c4-5530-a953-d63f4d081fe0&secret=2d2759bd-a1b0-57a7-803b-520c1a262740",
  "–ú–ò–ù–ò-–ö–ê–°–ö–û":            "https://widgets.inssmart.ru/contract/kasko?appId=293563a6-dcb8-543c-84a7-7a455578884f&secret=5d05ad7d-7fc6-58b8-8851-6de24394a0a6",
  –ò–ø–æ—Ç–µ–∫–∞:                 "https://widgets.inssmart.ru/contract/mortgage?appId=e06a1d3f-604c-52d2-bc8a-b9b8e2e7e167&secret=695aa6ff-001b-52ec-99de-0dbd38762b93",
  "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞": "https://widgets.inssmart.ru/contract/property?appId=34daded4-ba8c-5e60-883b-bddd168b35b0&secret=ff271c00-fb5a-5de2-9b9e-fcfb8660da84",
  –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è:             "https://widgets.inssmart.ru/contract/travel?appId=a8bf576a-c303-5c66-8952-5a2a5bcf0b04&secret=95f250f5-b561-5593-99ad-575fec648e4c"
};

// 2) Off-widget & blocked
const outsideTriggers = ["–ö–ê–°–ö–û –ü–û –†–ò–°–ö–ê–ú","–¢–û–¢–ê–õ","–£–ì–û–ù","–î–ú–°","–°–¢–†–ê–•–û–í–ê–ù–ò–ï –ë–ò–ó–ù–ï–°–ê"];
const outsideResp = `
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç –≤–∏–¥ –æ–Ω–ª–∞–π–Ω-–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.
–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:
üìß info@straxovka-go.ru  
üåê https://straxovka-go.ru  
üì± WhatsApp: +7 989 120 66 37
`.trim();
const blockedTopics = ["–ü–û–õ–ò–¢–ò–ö–ê","–¶–ï–†–ö–û–í–¨","–†–ï–õ–ò–ì–ò–Ø","–í–û–ô–ù–ê","–í–´–ë–û–†–´","–ú–ï–î–ò–¶–ò–ù","–õ–ï–ö–ê–†–°–¢–í–û","–í–†–ê–ß"];
const blockedResp = `
–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –æ–±—Å—É–∂–¥–∞—Ç—å —ç—Ç—É —Ç–µ–º—É.
üìß info@straxovka-go.ru  
üåê https://straxovka-go.ru
`.trim();

// 3) –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
bot.start(ctx => {
  const kb = Object.keys(services).map(k=>([{ text: k }]));
  return ctx.reply('üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å:', {
    reply_markup:{ keyboard:kb, resize_keyboard:true }
  });
});

// 4) Webhook
app.post('/webhook', (req, res) => {
  bot.handleUpdate(req.body, res).catch(console.error);
});

// 5) –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ö—ç–Ω–¥–ª–µ—Ä
bot.on('text', async ctx => {
  const txt   = ctx.message.text.trim();
  const up    = txt.toUpperCase();
  const cid   = String(ctx.chat.id);

  // init session
  let sess = sessions.get(cid);
  if (!sess) {
    sess = { history: [] };
    sessions.set(cid, sess);
  }

  // 5.1 –í–∏–¥–∂–µ—Ç-–∫–Ω–æ–ø–∫–∞
  if (services[txt]) {
    return ctx.replyWithHTML(
      `–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ <b>${txt}</b>:`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂', url:services[txt] } ]]
        }
      }
    );
  }

  // 5.2 Off-widget
  if (outsideTriggers.some(tr=>up.includes(tr))) {
    return ctx.reply(outsideResp);
  }

  // 5.3 –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
  if (blockedTopics.some(bt=>up.includes(bt))) {
    return ctx.reply(blockedResp);
  }

  // 5.4 –ñ—ë—Å—Ç–∫–∏–µ —à–∞–±–ª–æ–Ω—ã:

  // 1) –û–°–ê–ì–û –¥–ª—è —Ñ–∏–∑–ª–∏—Ü
  if (/–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –û–°–ê–ì–û|–û–°–ê–ì–û –î–õ–Ø –§–ò–ó–ò–ß–ï–°–ö–ò–• –õ–ò–¶/.test(up)) {
    return ctx.replyWithHTML(
      `–î–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü. ‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç–µ –û–°–ê–ì–û –æ–Ω–ª–∞–π–Ω ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ. –ß—Ç–æ–±—ã –Ω–∞–¥–µ–∂–Ω–æ –∑–∞—â–∏—Ç–∏—Ç—å —Å–µ–±—è –æ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –±–µ–∑ –û–°–ê–ì–û –∏–ª–∏ —Å –ø–æ–¥–¥–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª–∏—Å–∞–º–∏, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –ö–ê–°–ö–û –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä—ã–π –∏ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∑–∞—â–∏—Ç—É.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ö–ê–°–ö–û ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∑–∞—è–≤–∫–µ.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
 –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç–µ –û–°–ê–ì–û –æ–Ω–ª–∞–π–Ω', url:services['–û–°–ê–ì–û'] } ]]
        }
      }
    );
  }

  // 2) –û–°–ê–ì–û –¥–ª—è —é—Ä–ª–∏—Ü
  if (/–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –û–°–ê–ì–û –î–õ–Ø –Æ–†–ò–î–ò–ß–ï–°–ö–ò–• –õ–ò–¶|–û–°–ê–ì–û –î–õ–Ø –Æ–†–õ–ò–¶/.test(up)) {
    return ctx.replyWithHTML(
      `–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –û–°–ê–ì–û –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –æ–Ω–ª–∞–π–Ω:
‚ñ∂ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
 –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é', url:services['–û–°–ê–ì–û'] } ]]
        }
      }
    );
  }

  // 3) –ú–∏–Ω–∏-–ö–ê–°–ö–û
  if (/–ú–ò–ù–ò[- ]?–ö–ê–°–ö–û|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –ú–ò–ù–ò[- ]?–ö–ê–°–ö–û/.test(up)) {
    return ctx.replyWithHTML(
      `–ú–ò–ù–ò-–ö–ê–°–ö–û –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —É—â–µ—Ä–± –≤ –î–¢–ü –ø–æ –≤–∏–Ω–µ —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü, –∫–æ–≥–¥–∞ –≤–∏–Ω–æ–≤–Ω–∏–∫ –Ω–µ –∏–º–µ–µ—Ç –û–°–ê–ì–û –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã–π/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –ø–æ–ª–∏—Å.
–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –æ–Ω–ª–∞–π–Ω-–≤–∏–¥–∂–µ—Ç:
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û
–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ö–ê–°–ö–û –ø–æ –∑–∞—è–≤–∫–µ.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
 –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û', url:services['–ú–ò–ù–ò-–ö–ê–°–ö–û'] } ]]
        }
      }
    );
  }

  // 4) –ò–ø–æ—Ç–µ–∫–∞
  if (/–ò–ü–û–¢–ï–ö|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –ò–ü–û–¢–ï–ö–£/.test(up)) {
    return ctx.replyWithHTML(
      `–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏ ‚Äî –∑–∞—â–∏—Ç–∞ –ø–æ —Ä–∏—Å–∫–∞–º –∏–º—É—â–µ—Å—Ç–≤–∞, –∂–∏–∑–Ω–∏ –∏ —Ç–∏—Ç—É–ª–∞ —Å –≤—ã–≥–æ–¥–æ–π 10% –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –°–±–µ—Ä–±–∞–Ω–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
–ü–æ–º–Ω–∏—Ç–µ, –±–∞–Ω–∫ —Å—Ç—Ä–∞—Ö—É–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏ –≤–∞—à–µ–≥–æ –∂–∏–ª—å—è. –ß—Ç–æ–±—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—Ç–∏—Ç—å –¥–æ–º ‚Äî –æ—Ç–¥–µ–ª–∫—É, –º–µ–±–µ–ª—å –∏ –ª–∏—á–Ω—ã–µ –≤–µ—â–∏ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º.
–ú—ã –ø–æ–º–æ–∂–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ –æ–Ω–ª–∞–π–Ω:
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–∂–µ—Ç–∞ –∏–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞–º`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å', url:services['–ò–ø–æ—Ç–µ–∫–∞'] } ]]
        }
      }
    );
  }

  // 5) –ò–º—É—â–µ—Å—Ç–≤–æ (–ª–∏—á–Ω–æ–µ)
  if (/–ö–ê–ö –ó–ê–°–¢–†–ê–•–û–í–ê–¢–¨ –ò–ú–£–©–ï–°–¢–í–û|–ò–ú–£–©–ï–°–¢–í–û/.test(up)) {
    return ctx.replyWithHTML(
      `–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ ‚Äî –ª–∏—á–Ω–æ–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, –¥–æ–º–∞, –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤, –∫–æ–º–Ω–∞—Ç—ã, —Ç–∞—É–Ω—Ö–∞—É—Å–∞, –¥–æ–º–∞ —Å —É—á–∞—Å—Ç–∫–æ–º, –±–∞–Ω–∏.
üìå –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –∏–ø–æ—Ç–µ–∫–µ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –≠—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç –ø–æ–ª–∏—Å, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –¥–ª—è –±–∞–Ω–∫–∞, –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –ø–æ–ª–Ω—É—é –∑–∞—â–∏—Ç—É –≤–∞—à–µ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞.
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂–û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω', url:services['–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞'] } ]]
        }
      }
    );
  }

  // 6) –ò–º—É—â–µ—Å—Ç–≤–æ (–∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ)
  if (/–ö–û–ú–ú–ï–†–ß–ï–°–ö–û–ï –ò–ú–£–©–ï–°–¢–í–û|–ö–ê–ö –ó–ê–°–¢–†–ê–•–û–í–ê–¢–¨ –ö–û–ú–ú–ï–†–ß/.test(up)) {
    return ctx.replyWithHTML(
      `–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ ‚Äî –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ñ–∏—Å–∞, —Å–∫–ª–∞–¥–∞, –º–∞–≥–∞–∑–∏–Ω–∞, –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏–π.
–ß—Ç–æ–±—ã –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –ø–µ—Ä–µ—á–Ω–µ–º —Ä–∏—Å–∫–æ–≤ –∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ–ª–∏—Å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω
–í—ã –Ω–µ –Ω–∞—à–ª–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ?
–û—Å—Ç–∞–≤—å—Ç–µ –Ω–∞–º –∑–∞—è–≤–∫—É.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω', url:services['–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞'] } ]]
        }
      }
    );
  }

  // 7) –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  if (/–ü–£–¢–ï–®–ï–°–¢–í–ò–Ø|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –ü–û–õ–ò–° –î–õ–Ø –ü–£–¢–ï–®–ï–°–¢–í–ò–ô/.test(up)) {
    return ctx.replyWithHTML(
      `–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –Ω–∞—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.–¢–∞–º –≤—ã —Å–º–æ–∂–µ—Ç–µ –±—ã—Å—Ç—Ä–æ –≤—ã–±—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ:
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ, –º—ã  –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru`,
      {
        reply_markup:{
          inline_keyboard:[[ { text:'‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å', url:services['–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'] } ]]
        }
      }
    );
  }

  // 5.5) AI-fallback
  session.history.push({ role:'user', content:txt });
  const first = !privacyMentioned.get(cid);
  let sys = `
–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Straxovka-Go, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—é.
–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, —Å —ç–º–ø–∞—Ç–∏–µ–π –∏ –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é.
`;
  if (first) {
    sys += `
–£–ø–æ–º—è–Ω–∏, —á—Ç–æ –º—ã ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ü–î–Ω, –∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É:
https://straxovka-go.ru/privacy
`;
    privacyMentioned.set(cid, true);
  } else {
    sys += "\n–ù–µ —É–ø–æ–º–∏–Ω–∞–π –ø–æ–ª–∏—Ç–∏–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ.";
  }
  const msgs = [{ role:'system', content:sys.trim() }, ...session.history];

  try {
    const r = await openai.chat.completions.create({
      model:       'openai/gpt-4o-mini',
      messages:    msgs,
      temperature: 0.6,
      max_tokens: 200
    });
    const ans = r.choices[0].message.content.trim();
    session.history.push({ role:'assistant', content:ans });
    return ctx.reply(ans);
  } catch (e) {
    console.error("OpenRouter Error:", e);
    return ctx.reply("–£–ø—Å, –æ—à–∏–±–∫–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
});

// 6) Launch + webhook
app.listen(PORT, async () => {
  console.log(`üåê HTTP server on port ${PORT}`);
  await bot.telegram.setWebhook(`${DOMAIN}/webhook`);
  console.log(`‚úÖ Webhook registered at ${DOMAIN}/webhook`);
});
