import 'dotenv/config';
import express      from 'express';
import { Telegraf } from 'telegraf';

const {
  TELEGRAM_TOKEN,
  DOMAIN,
  PORT = 8080
} = process.env;

if (!TELEGRAM_TOKEN || !DOMAIN) {
  console.error('‚ùå –ó–∞–¥–∞–π—Ç–µ TELEGRAM_TOKEN –∏ DOMAIN –≤ env');
  process.exit(1);
}

// Express + healthcheck
const app = express();
app.use(express.json());
app.get('/', (_req, res) => res.send('OK'));

// Telegram bot
const bot = new Telegraf(TELEGRAM_TOKEN);

// 1) –í–∏–¥–∂–µ—Ç—ã
const services = {
  –û–°–ê–ì–û:                   "https://widgets.inssmart.ru/contract/eosago?appId=bbac9045-39c4-5530-a953-d63f4d081fe0&secret=2d2759bd-a1b0-57a7-803b-520c1a262740",
  "–ú–ò–ù–ò-–ö–ê–°–ö–û":            "https://widgets.inssmart.ru/contract/kasko?appId=293563a6-dcb8-543c-84a7-7a455578884f&secret=5d05ad7d-7fc6-58b8-8851-6de24394a0a6",
  –ò–ø–æ—Ç–µ–∫–∞:                 "https://widgets.inssmart.ru/contract/mortgage?appId=e06a1d3f-604c-52d2-bc8a-b9b8e2e7e167&secret=695aa6ff-001b-52ec-99de-0dbd38762b93",
  "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞": "https://widgets.inssmart.ru/contract/property?appId=34daded4-ba8c-5e60-883b-bddd168b35b0&secret=ff271c00-fb5a-5de2-9b9e-fcfb8660da84",
  –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è:             "https://widgets.inssmart.ru/contract/travel?appId=a8bf576a-c303-5c66-8952-5a2a5bcf0b04&secret=95f250f5-b561-5593-99ad-575fec648e4c"
};

// 2) Off-widget & blocked
const outsideTriggers = [
  "–ö–ê–°–ö–û –ü–û –†–ò–°–ö–ê–ú","–¢–û–¢–ê–õ","–£–ì–û–ù","–î–ú–°","–°–¢–†–ê–•–û–í–ê–ù–ò–ï –ë–ò–ó–ù–ï–°–ê",
  "–£–©–ï–†–ë","–ü–û–î–•–û–î–ò–¢ –î–õ–Ø –ë–ê–ù–ö–ê","–î–û–ë–†–û–í–û–õ–¨–ù–û–ï –ú–ï–î–ò–¶–ò–ù–°–ö–û–ï –°–¢–†–ê–•–û–í–ê–ù–ò–ï"
];
const outsideResp = `
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ—Ç –≤–∏–¥ –æ–Ω–ª–∞–π–Ω-–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.
–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:
üìß info@straxovka-go.ru  
üåê https://straxovka-go.ru  
üì± WhatsApp: +7 989 120 66 37
`.trim();

const blockedTopics = [
  "–ü–û–õ–ò–¢–ò–ö–ê","–†–ï–õ–ò–ì–ò–Ø","–í–û–ô–ù–ê","–í–´–ë–û–†–´",
  "–ú–ï–î–ò–¶–ò–ù","–õ–ï–ö–ê–†–°–¢–í–û","–í–†–ê–ß"
];
const blockedResp = `
–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É –æ–±—Å—É–∂–¥–∞—Ç—å —ç—Ç—É —Ç–µ–º—É.
üìß info@straxovka-go.ru  
üåê https://straxovka-go.ru
`.trim();

// 3) –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
bot.start(ctx => {
  const keyboard = Object.keys(services).map(k => ([{ text: k }]));
  return ctx.reply(
    'üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å:',
    { reply_markup: { keyboard, resize_keyboard: true } }
  );
});

// 4) Webhook
app.post('/webhook', (req, res) => {
  bot.handleUpdate(req.body, res).catch(console.error);
});

// 5) –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ö—ç–Ω–¥–ª–µ—Ä: —Ç–æ–ª—å–∫–æ —à–∞–±–ª–æ–Ω—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã
bot.on('text', ctx => {
  const txt = ctx.message.text.trim();
  const up  = txt.toUpperCase();

  // 5.1 –í–∏–¥–∂–µ—Ç-–∫–Ω–æ–ø–∫–∞
  if (services[txt]) {
    return ctx.replyWithHTML(
      `–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ <b>${txt}</b>:`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –æ—Ñ–æ—Ä–º–∏—Ç—å', url: services[txt] }
          ]]
        }
      }
    );
  }

  // 5.2 Off-widget
  if (outsideTriggers.some(tr => up.includes(tr))) {
    return ctx.reply(outsideResp);
  }

  // 5.3 –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
  if (blockedTopics.some(bt => up.includes(bt))) {
    return ctx.reply(blockedResp);
  }

  // 5.4 –ñ—ë—Å—Ç–∫–∏–µ —à–∞–±–ª–æ–Ω—ã:

  // 1) –û–°–ê–ì–û –¥–ª—è —Ñ–∏–∑–ª–∏—Ü
  if (/–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –û–°–ê–ì–û|–û–°–ê–ì–û –î–õ–Ø –§–ò–ó–ò–ß–ï–°–ö–ò–•/.test(up)) {
    return ctx.replyWithHTML(
      `–î–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü. –û—Ñ–æ—Ä–º–∏—Ç–µ –û–°–ê–ì–û –æ–Ω–ª–∞–π–Ω ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ. –ß—Ç–æ–±—ã –Ω–∞–¥–µ–∂–Ω–æ –∑–∞—â–∏—Ç–∏—Ç—å —Å–µ–±—è –æ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –±–µ–∑ –û–°–ê–ì–û –∏–ª–∏ —Å –ø–æ–¥–¥–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª–∏—Å–∞–º–∏, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Ñ–æ—Ä–º–∏—Ç—å –ö–ê–°–ö–û –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä—ã–π –∏ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∑–∞—â–∏—Ç—É.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ö–ê–°–ö–û ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –∑–∞—è–≤–∫–µ.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç–µ –û–°–ê–ì–û –æ–Ω–ª–∞–π–Ω', url: services['–û–°–ê–ì–û'] }
          ]]
        }
      }
    );
  }

  // 2) –û–°–ê–ì–û –¥–ª—è —é—Ä–ª–∏—Ü
  if (/–û–°–ê–ì–û –î–õ–Ø –Æ–†–ò–î–ò–ß–ï–°–ö–ò–• –õ–ò–¶|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –û–°–ê–ì–û –î–õ–Ø –Æ–†/.test(up)) {
    return ctx.replyWithHTML(
      `–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –û–°–ê–ì–û –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ –æ–Ω–ª–∞–π–Ω:
‚ñ∂ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é', url: services['–û–°–ê–ì–û'] }
          ]]
        }
      }
    );
  }

  // 3) –ú–ò–ù–ò-–ö–ê–°–ö–û
  if (/–ú–ò–ù–ò[- ]?–ö–ê–°–ö–û|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –ú–ò–ù–ò/.test(up)) {
    return ctx.replyWithHTML(
      `–ú–ò–ù–ò-–ö–ê–°–ö–û –æ—Ç –ë–µ—Å–ø–æ–ª–∏—Å–Ω—ã—Ö –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —É—â–µ—Ä–± –≤ –î–¢–ü –ø–æ –≤–∏–Ω–µ —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü, –∫–æ–≥–¥–∞ –≤–∏–Ω–æ–≤–Ω–∏–∫ –Ω–µ –∏–º–µ–µ—Ç –û–°–ê–ì–û –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã–π/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –ø–æ–ª–∏—Å.
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û
–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ö–ê–°–ö–û –ø–æ –∑–∞—è–≤–∫–µ.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ú–ò–ù–ò-–ö–ê–°–ö–û', url: services['–ú–ò–ù–ò-–ö–ê–°–ö–û'] }
          ]]
        }
      }
    );
  }

  // 4) –ò–ø–æ—Ç–µ–∫–∞
  if (/–ò–ü–û–¢–ï–ö|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –ò–ü–û–¢–ï–ö–£/.test(up)) {
    return ctx.replyWithHTML(
      `–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–ø–æ—Ç–µ–∫–∏ ‚Äî –∑–∞—â–∏—Ç–∞ –ø–æ —Ä–∏—Å–∫–∞–º –∏–º—É—â–µ—Å—Ç–≤–∞, –∂–∏–∑–Ω–∏ –∏ —Ç–∏—Ç—É–ª–∞ —Å –≤—ã–≥–æ–¥–æ–π 10% –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –°–±–µ—Ä–±–∞–Ω–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É', url: services['–ò–ø–æ—Ç–µ–∫–∞'] }
          ]]
        }
      }
    );
  }

  // 5) –õ–∏—á–Ω–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ
  if (/–ö–ê–ö –ó–ê–°–¢–†–ê–•–û–í–ê–¢–¨ –ò–ú–£–©–ï–°–¢–í–û|–ò–ú–£–©–ï–°–¢–í–û/.test(up)) {
    return ctx.replyWithHTML(
      `–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ ‚Äî –ª–∏—á–Ω–æ–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä—ã, –¥–æ–º–∞, –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤, –∫–æ–º–Ω–∞—Ç—ã, —Ç–∞—É–Ω—Ö–∞—É—Å–∞, –¥–æ–º–∞ —Å —É—á–∞—Å—Ç–∫–æ–º, –±–∞–Ω–∏.
üìå –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –≤ –∏–ø–æ—Ç–µ–∫–µ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω', url: services['–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞'] }
          ]]
        }
      }
    );
  }

  // 6) –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ
  if (/–ö–û–ú–ú–ï–†–ß–ï–°–ö–û–ï –ò–ú–£–©–ï–°–¢–í–û|–ö–ê–ö –ó–ê–°–¢–†–ê–•–û–í–ê–¢–¨ –ö–û–ú–ú–ï–†–ß/.test(up)) {
    return ctx.replyWithHTML(
      `–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞ ‚Äî –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ—Ñ–∏—Å–∞, —Å–∫–ª–∞–¥–∞ –∏ —Ç. –¥.
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω
–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É.
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –æ–Ω–ª–∞–π–Ω', url: services['–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞'] }
          ]]
        }
      }
    );
  }

  // 7) –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è
  if (/–ü–£–¢–ï–®–ï–°–¢–í–ò–Ø|–ö–ê–ö –û–§–û–†–ú–ò–¢–¨ –ü–û–õ–ò–° –î–õ–Ø –ü–£–¢–ï–®–ï–°–¢–í–ò–ô/.test(up)) {
    return ctx.replyWithHTML(
      `–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –∑–∞ –≥—Ä–∞–Ω–∏—Ü—É, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º:
‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ, –º—ã –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å!
–ö–æ–Ω—Ç–∞–∫—Ç—ã:
 üåê straxovka-go.ru
 üì≤ WhatsApp: +7 989 120 66 37
 üìß info@straxovka-go.ru`,
      {
        reply_markup: {
          inline_keyboard: [[
            { text: '‚ñ∂ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–ª–∏—Å –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π', url: services['–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'] }
          ]]
        }
      }
    );
  }

  // 5.5) –§–æ–ª–±—ç–∫: –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å –æ–¥–Ω—É –∏–∑ —É—Å–ª—É–≥
  return ctx.reply(
    '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —É—Å–ª—É–≥ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å\n' +
    '–í—ã –º–æ–∂–µ—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\n' +
    'üìß info@straxovka-go.ru  üåê https://straxovka-go.ru  üì± +7 989 120 66 37'
  );
});

// 6) –ó–∞–ø—É—Å–∫ + webhook
app.listen(PORT, async () => {
  console.log(`üåê HTTP server listening on port ${PORT}`);
  await bot.telegram.setWebhook(`${DOMAIN}/webhook`);
  console.log(`‚úÖ Webhook registered at ${DOMAIN}/webhook`);
});
